<analysis>**original_problem_statement:**
1.  **Product Overview**
    *   **Product Name:** UNIFY
    *   **Product Type:** Multi-tenant SaaS Admission & Counselling Platform.
    *   **Goal:** Provide universities with an end-to-end system for student lead management, counselling, configurable registration, online tests, document handling, and fee collection, with a Super Admin for platform-level oversight.

2.  **Core MVP Features**
    *   Configurable Student Registration Workflow.
    *   Lead Management System with bulk actions and auto-assignment.
    *   Payment Module (Razorpay).
    *   Notifications (Brevo).
    *   Comprehensive Reporting and Data Export.

3.  **Recent User Requests**
    *   **University Profile:** Add a feature for universities to add About information and a Gallery, which should be visible on the Student Dashboard.
    *   **Lead Management:** Implement bulk lead upload (CSV) for Counselling Managers and set up rules for lead auto-assignment.
    *   **Brevo Integration:** Integrate Brevo for transactional emails using the provided API key.
    *   **Data Export:** Implement Export to CSV functionality for all data tables across the application.
    *   **Analytics:** Implement lead source analytics and other advanced reporting dashboards.
    *   **Integrations:** Implement integrations with third-party lead sources like Shiksha and Collegedunia.
    *   **Deferred:** Real Razorpay integration with live keys is deferred for now.

**User's preferred language**: English

**what currently exists?**
The agent has significantly advanced the UNIFY platform, turning most placeholder pages into functional modules.
- **Super Admin Panel:** Fully functional, including dashboards for payments, analytics, and system health. University management (view, edit, create admin) is complete and working. A Change Password feature has been added for the super admin.
- **University Admin Panel:** All pages are now functional, including Departments, Courses, Sessions, Registration Configuration, Staff Management, and a new Settings page to manage the university's public profile (About info, Gallery).
- **Student Panel:** The application workflow has been enhanced with a functional document upload system. A new Know Your Institution page displays the university's profile and gallery. An entrance test page has been created and wired up.
- **Counselling Panel:** Dashboards for both Counselling Managers and Counsellors have been created. The manager's view includes team management, bulk lead upload (CSV), and stubs for auto-assignment rules.
- **Backend:** Numerous API endpoints have been added to support all the new frontend features, including document handling, bulk lead uploads, and dashboard statistics.
- **Bug Fixes:** The agent fixed a critical routing issue with the Super Admin login link and resolved all user-reported bugs regarding university management.

**Last working item**:
-   **Last item agent was working:** The agent was initiating the Brevo integration for transactional emails. It received the playbook from the integration subagent and was attempting to add the user-provided  to the  file.
-   **Status:** BLOCKED
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** backend testing agent
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1 (P0): Corrupted backend .env file**
-   **Issue 2 (P2): Incorrect HTTP Status Code**
-   **Issue 3 (P2): Session management inconsistencies**

Issues Detail:
-   **Issue 1: Corrupted backend .env file**
    -   **Attempted fixes:** The agent tried to add the  to  but appended it incorrectly, resulting in a malformed line: .
    -   **Next debug checklist:**
        1.  View the file .
        2.  Use  to find the malformed line and replace it with the correct format: .
        3.  Restart the backend service (backend: stopped
backend: started) and check logs to ensure it starts correctly and can read the environment variable.
    -   **Why fix this issue and what will be achieved with the fix?** This is a critical blocker. The backend will fail to start or function correctly until the  file is fixed. Resolving this unblocks the Brevo integration.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** None

-   **Issue 2: Incorrect HTTP Status Code**
    -   **Attempted fixes:** None. This was noted in the first test report and has been deferred.
    -   **Next debug checklist:** Review authentication middleware and exception handlers in  to ensure s for authentication errors use a  status code instead of .
    -   **Why fix this issue and what will be achieved with the fix?** Adheres to web standards, making the API more predictable for clients.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** None

-   **Issue 3: Session management inconsistencies**
    -   **Attempted fixes:** None. Noted in the first test report.
    -   **Next debug checklist:** Review the logout logic in  and verify JWT expiry handling on both frontend and backend.
    -   **Why fix this issue and what will be achieved with the fix?** Ensures secure and predictable user sessions.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on other issue:** None

**In progress Task List**:
-   **Task 1: Integrate Brevo for Transactional Emails**
    -   **Where to resume:** .
    -   **What will be achieved with this?** The application will be able to send transactional emails (e.g., on user creation, password reset) using the Brevo API.
    -   **Status:** BLOCKED
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on something:** **Issue 1: Corrupted backend .env file**.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P0) Export to CSV:** Add an Export button to all data tables in the Super Admin, University Admin, and Counselling panels. This will require a generic backend utility and frontend component.
    -   **(P1) Advanced Reporting & Analytics:** Implement lead source analytics on the Counselling Manager dashboard and build out the other advanced reporting dashboards requested by the user.
    -   **(P1) Lead Auto-Assignment Rules:** Implement the UI and backend logic for University Admins to define rules for automatically assigning new leads to counsellors.
    -   **(P2) Third-Party Integrations:** Create backend endpoints and services to ingest leads from external APIs like Shiksha and Collegedunia.

-   **Future Tasks:**
    -   **Real Razorpay Integration:** Complete the payment module using real API keys and webhooks for payouts.
    -   **Advanced Reporting:** Add more complex charts and data visualizations to all dashboards.

**Completed work in this session**
-   **University Management Fixed:** Resolved issues with Edit, View, and Create Admin functionality for universities in the Super Admin panel.
-   **Super Admin Panel Complete:** Implemented functional pages for Payments, Analytics, and System Health.
-   **Super Admin Password Change:** Added a feature for Super Admins to change their own password.
-   **Public & Auth Pages Fixed:** Correctly routed all public pages and fixed a critical bug in the Super Admin login link.
-   **University Admin Panel Complete:** Built and integrated all required pages: Departments, Courses, Sessions, Question Bank, Payments, and Settings.
-   **University Profile Feature:** Implemented UI and backend for universities to manage their About info and image Gallery.
-   **Student Panel Enhancements:**
    -   Implemented a full-featured Document Upload system in the student application.
    -   Created an Institution page for students to view the university's profile.
    -   Created the page stub for the Entrance Test.
-   **Counselling Panel Built:**
    -   Created dashboards for Counselling Managers and Counsellors.
    -   Implemented Bulk Lead Upload via CSV for managers.
    -   Created pages for Team Management.
-   **Rigorous Testing:** Successfully used the testing agent multiple times (, , ) to validate major new features and fix bugs.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1:** Incorrect HTTP status code (403 instead of 401) for some auth errors.
-   **Issue 2:** Potential session management inconsistencies.

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Backend:** FastAPI, MongoDB (Motor), Pydantic, JWT.
-   **Frontend:** React, React Router, Tailwind CSS, Shadcn/UI, Axios.
-   **Architecture:** Multi-tenant SaaS, Role-Based Access Control (RBAC).

**key DB schema**
-   **universities:** Now utilizes  (string), and  (list of strings/URLs).
-   **users:** , , , .
-   **leads:** , , , , , , , .
-   **documents:** , , , .

**changes in tech stack**
None.

**All files of reference**
-   **Key Updated Files:**
    -   : Malformed, needs immediate fix.
    -   : Heavily modified with numerous new routers and endpoints.
    -   : Heavily modified to include routes for all new pages.
    -   : Updated with many new API service calls.
    -   : Reworked to support document uploads.
    -   : Updated to include the Change Password dialog.
-   **Key New Files:**
    -   All pages under .
    -   All pages under .
    -   
    -   

**Areas that need refactoring**:
-   Frontend API error handling should be centralized in  or a custom hook to avoid repetition.
-   The new pages created for the University and Counselling panels have a lot of repeated code for data tables, modals, and fetching logic. Creating reusable components for these would be beneficial.

**key api endpoints**
-   : Allows an authenticated user to change their own password.
-   : Updates a university's public profile info.
-   : Full CRUD endpoints for student document management.
-   : For Counselling Managers to upload leads from a CSV.
-   : Fetches stats for the Counselling Manager dashboard.
-   : Fetches stats for the Counsellor dashboard.

**Critical Info for New Agent**
-   **Your first action MUST be to fix the  file.** The backend will not work otherwise.
-   The user has provided a clear set of priorities: Brevo integration, Export to CSV, and then Analytics/Reporting. Defer Razorpay implementation.
-   The project has a robust set of automated tests. Use the  after implementing significant features to ensure no regressions.
-   Credentials for both Super Admin and a test University Admin are available and have been used successfully.

**documents and test reports created in this job**
-   
-   
-   
-   Updated 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (Latest):** Provides Brevo API key, defers Razorpay, and sets the next priorities: Export to CSV, lead source analytics, 3rd party integrations, and advanced reporting. (IN PROGRESS)
2.  **User:** Asks to complete all University Admin pages. (COMPLETED)
3.  **User:** Asks to go to the next action items and add a change password feature for the Super Admin. (COMPLETED)
4.  **User:** Reports the Super Admin login page is not working. (COMPLETED - Fixed by agent)
5.  **User:** Approves the agent's initial plan and suggests using mock data. (ACKNOWLEDGED)

**Project Health Check:**
-   **Broken:**
    -    file is corrupted, blocking the backend service.
-   **Mocked:**
    -   Lead auto-assignment rules are not yet implemented.
    -   Razorpay and Brevo integrations are pending implementation.

**3rd Party Integrations**
-   **Razorpay:** Playbook fetched. Implementation deferred by user.
-   **Brevo:** Playbook fetched. API key provided. **Implementation is in progress but blocked.**

**Testing status**
-   **Testing agent used after significant changes:** YES (run 3 times in this session)
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** The testing agent created and ran tests in . Test reports are in .
-   **Known regressions:** None. The agent successfully fixed all identified issues and passed regression tests.

**Credentials to test flow:**
-   **Super Admin:**
    -   **Email:** 
    -   **Password:** 
-   **University Admin (for 'Test University Updated'):**
    -   **Person ID:** 
    -   **Password:** 

**What agent forgot to execute**
-   The agent did not address the lower-priority issues from the initial handoff: the  HTTP status code inconsistency and the potential session management inconsistencies. These should be added to the backlog.</analysis>
